<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.22.xsd">

    <!-- language table -->
    <changeSet id="1-create-language" author="hoang">
        <createTable tableName="language">
            <column name="language_id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="language_name" type="VARCHAR(255)"/>
            <column name="language_code" type="VARCHAR(50)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    
     <!-- topic table -->
    <changeSet id="2-create-topic" author="hoang">
        <createTable tableName="topic">
            <column name="topic_id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="topic_uuid" type="VARCHAR(100)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="topic_name" type="VARCHAR(255)"/>
            <column name="default_language_code" type="VARCHAR(50)"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="topic"
                                 baseColumnNames="default_language_code"
                                 constraintName="fk_topic_language"
                                 referencedTableName="language"
                                 referencedColumnNames="language_code"/>
    </changeSet>

    <!-- topic_translation table -->
    <changeSet id="3-create-topic-translation" author="hoang">
        <createTable tableName="topic_translation">
            <column name="topic_uuid" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="language_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="topic_name" type="VARCHAR(255)"/>
        </createTable>
        <addPrimaryKey tableName="topic_translation"
                       columnNames="topic_uuid, language_code"
                       constraintName="pk_topic_translation"/>
        <addForeignKeyConstraint baseTableName="topic_translation"
                                 baseColumnNames="topic_uuid"
                                 constraintName="fk_topic_translation_topic"
                                 referencedTableName="topic"
                                 referencedColumnNames="topic_uuid"/>
        <addForeignKeyConstraint baseTableName="topic_translation"
                                 baseColumnNames="language_code"
                                 constraintName="fk_topic_translation_language"
                                 referencedTableName="language"
                                 referencedColumnNames="language_code"/>
    </changeSet>

    <!-- serial_article table -->
    <changeSet id="4-create-serial-article" author="hoang">
        <createTable tableName="serial_article">
            <column name="serial_article_id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="serial_article_uuid" type="VARCHAR(100)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="serial_article_name" type="VARCHAR(255)"/>
            <column name="default_language_code" type="VARCHAR(50)"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="serial_article"
                                 baseColumnNames="default_language_code"
                                 constraintName="fk_serial_article_language"
                                 referencedTableName="language"
                                 referencedColumnNames="language_code"/>
    </changeSet>
    
     <!-- serial_article_topic table -->
    <changeSet id="db9a4d84-1148-49b2-9ea4-6d00dc2c0a3f" author="hoang">
        <createTable tableName="serial_article_topic">
            <column name="serial_article_uuid" type="VARCHAR(100)"/>
            <column name="topic_uuid" type="VARCHAR(100)"/>
            <column name="master_topic" type="BOOLEAN" defaultValueBoolean="false"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="serial_article_topic"
                                 baseColumnNames="serial_article_uuid"
                                 constraintName="fk_serial_article_topic_serial_article_uuid"
                                 referencedTableName="serial_article"
                                 referencedColumnNames="serial_article_uuid"/>
        <addForeignKeyConstraint baseTableName="serial_article_topic"
                                 baseColumnNames="topic_uuid"
                                 constraintName="fk_serial_article_topic_topic_uuid"
                                 referencedTableName="topic"
                                 referencedColumnNames="topic_uuid"/>
    </changeSet>
    
    <!-- serial_article_translation table -->
    <changeSet id="5-create-serial-article-translation" author="hoang">
        <createTable tableName="serial_article_translation">
            <column name="serial_article_uuid" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="language_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="serial_article_name" type="VARCHAR(255)"/>
        </createTable>
        <addPrimaryKey tableName="serial_article_translation"
                       columnNames="serial_article_uuid, language_code"
                       constraintName="pk_serial_article_translation"/>
        <addForeignKeyConstraint baseTableName="serial_article_translation"
                                 baseColumnNames="serial_article_uuid"
                                 constraintName="fk_serial_article_translation_serial_article"
                                 referencedTableName="serial_article"
                                 referencedColumnNames="serial_article_uuid"/>
        <addForeignKeyConstraint baseTableName="serial_article_translation"
                                 baseColumnNames="language_code"
                                 constraintName="fk_serial_article_translation_language"
                                 referencedTableName="language"
                                 referencedColumnNames="language_code"/>
    </changeSet>

    <!-- article table -->
    <changeSet id="6-create-article" author="hoang">
        <createTable tableName="article">
            <column name="article_id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="article_uuid" type="VARCHAR(100)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="article_name" type="VARCHAR(255)"/>
            <column name="article_content" type="TEXT"/>
            <column name="serial_article_uuid" type="VARCHAR(100)"/>
            <column name="view_counter" type="INT" defaultValueNumeric="0"/>
            <column name="default_language_code" type="VARCHAR(50)" defaultValue="int"/><!-- int = international -->
            <column name="date_created" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="date_updated" type="TIMESTAMP" />
            <column name="created_user" type="VARCHAR(100)" 
                    defaultValue="admin"/>
            <column name="updated_user" type="VARCHAR(100)"/>
            <column name="source_reference" type="VARCHAR(1000)"/>
            <column name="chapter_id" type="INT"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="article"
                                 baseColumnNames="serial_article_uuid"
                                 constraintName="fk_article_serial"
                                 referencedTableName="serial_article"
                                 referencedColumnNames="serial_article_uuid"/>
        <addForeignKeyConstraint baseTableName="article"
                                 baseColumnNames="default_language_code"
                                 constraintName="fk_article_language"
                                 referencedTableName="language"
                                 referencedColumnNames="language_code"/>                      
    <addForeignKeyConstraint baseTableName="article"
                             baseColumnNames="created_user"
                             constraintName="fk_article_app_user_created_user"
                             referencedTableName="app_user"
                             referencedColumnNames="user_name"/>
    <addForeignKeyConstraint baseTableName="article"
                             baseColumnNames="updated_user"
                             constraintName="fk_article_app_user_updated_user"
                             referencedTableName="app_user"
                             referencedColumnNames="user_name"/>  
    </changeSet>

    <!-- article_translation table -->
    <changeSet id="7-create-article-translation" author="hoang">
        <createTable tableName="article_translation">
            <column name="article_uuid" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="language_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="article_name" type="VARCHAR(255)"/>
            <column name="article_content" type="TEXT"/>
            <column name="serial_article_uuid" type="VARCHAR(100)"/>
            <column name="date_created" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="date_updated" type="TIMESTAMP"/>
            <column name="created_user" type="VARCHAR(100)" 
                    defaultValue="admin"/>
            <column name="updated_user" type="VARCHAR(100)"/>
            <column name="source_reference" type="VARCHAR(1000)"/>
            <column name="chapter_id" type="INT"/>            
        </createTable>
        <addPrimaryKey tableName="article_translation" 
                       columnNames="article_uuid, language_code" 
                       constraintName="pk_article_translation"/>
        <addForeignKeyConstraint baseTableName="article_translation"
                                 baseColumnNames="article_uuid"
                                 constraintName="fk_article_translation_article"
                                 referencedTableName="article"
                                 referencedColumnNames="article_uuid"/>
        <addForeignKeyConstraint baseTableName="article_translation"
                                 baseColumnNames="language_code"
                                 constraintName="fk_article_translation_language"
                                 referencedTableName="language"
                                 referencedColumnNames="language_code"/>
        <addForeignKeyConstraint baseTableName="article_translation"
                                 baseColumnNames="created_user"
                                 constraintName="fk_article_translation_app_user_created_user"
                                 referencedTableName="app_user"
                                 referencedColumnNames="user_name"/>
                                 
        <addForeignKeyConstraint baseTableName="article_translation"
                                 baseColumnNames="updated_user"
                                 constraintName="fk_article_translation_app_user_updated_user"
                                 referencedTableName="app_user"
                                 referencedColumnNames="user_name"/>                                   
    </changeSet>

    <!-- article_topic table -->
    <changeSet id="8-create-article-topic" author="hoang">
        <createTable tableName="article_topic">
            <column name="article_uuid" type="VARCHAR(100)"/>
            <column name="topic_uuid" type="VARCHAR(100)"/>
            <column name="master_topic" type="BOOLEAN" defaultValueBoolean="false"/>
        </createTable>
	    <addPrimaryKey 
	        tableName="article_topic" 
	        columnNames="article_uuid,topic_uuid" 
	        constraintName="article_topic_pkey"/>
        <addForeignKeyConstraint baseTableName="article_topic"
                                 baseColumnNames="article_uuid"
                                 constraintName="fk_article_topic_article"
                                 referencedTableName="article"
                                 referencedColumnNames="article_uuid"/>
        <addForeignKeyConstraint baseTableName="article_topic"
                                 baseColumnNames="topic_uuid"
                                 constraintName="fk_article_topic_topic"
                                 referencedTableName="topic"
                                 referencedColumnNames="topic_uuid"/>
    </changeSet>

	<!-- 9. page_visit_counter table -->
    <changeSet id="9-create-page-visit-counter" author="hoang">
        <createTable tableName="page_visit_counter">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="count" type="INT"/>
        </createTable>

        <!-- Insert initial singleton row -->
        <insert tableName="page_visit_counter">
            <column name="id" value="1"/>
            <column name="count" value="0"/>
        </insert>
    </changeSet>
</databaseChangeLog>
